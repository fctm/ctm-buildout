<?xml version="1.0" encoding="UTF-8"?>
<rules 
    xmlns="http://namespaces.plone.org/diazo"
    xmlns:css="http://namespaces.plone.org/diazo/css"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

    <!-- Defines a xsl variable corresponding to the portal root -->
    <xsl:variable name="portal_root" select="id('portal-logo')/@href"/>
    
    <!-- Defines a xsl variable corresponding to the portal title -->
    <xsl:variable name="portal_title" select="id('portal-logo')/@title"/>

  <!-- theme wrapper, to prevent theming ZMI -->
  <rules css:if-content="#visual-portal-wrapper">

    <!-- Theme -->  
    <theme href="theme.html"/>
    <!-- prevent theming if $ajax_load is true -->
    <notheme if="$ajax_load" />
    <!-- prevent theming manage-portlets view -->
    <notheme css:if-content="body.template-manage-portlets" />
    <!-- prevent theming usergroup-userprefs view -->
    <notheme css:if-content="body.template-usergroup-userprefs" />
    
    
    <!-- Refills the head and references our stylesheet from the standalone view /@@ctm-theme-css -->  
    <append css:theme="head">
      <link media="screen" href="{$portal_root}/@@ctm-theme-css" type="text/css" rel="stylesheet"/>
    </append>
    
    <!-- Drops the favicon link in the content /html/head -->
    <xsl:template match="//link[@rel='shortcut icon']">
      <xsl:copy>
	<xsl:apply-templates select="/link[@rel='shortcut icon']"/>
      </xsl:copy>
    </xsl:template>
    <xsl:template match="//link[@rel='shortcut icon']"/> 
    
    <!-- Picks the favicon image from the view generated by ctm.colorpalette package -->
    <append css:theme="head">
      <link rel="shortcut icon" href="{$portal_root}/@@ctm-theme-favicon"/>
    </append>
    
    <prepend theme="/html/head" content="/html/head" /> 
    
    <!-- Inject body classes from Plone into the theme -->
    <copy attributes="*" css:theme="body" css:content="body" />
    
    <!-- Portal Header -->  
    <replace css:content="#portal-logo">
      <a id="ctm-logo" href="{$portal_root}" title="{$portal_title}">
	<div></div>
      </a>
    </replace> 
    
    <replace css:theme="#portal-top" css:content="#portal-top" /> 
    
    <!-- Picks up the main Plone content content to our theme -->  
    <replace css:theme="#portal-columns" css:content="#portal-columns" />
    
    <!-- Fills the portal site actions in the theme -->  
    <replace css:theme="#portal-siteactions" css:content="#portal-siteactions" />
    
    <!-- Imports href page into the footer -->  
    <replace css:theme="#socios" css:content="body" href="/@@ctm-theme-footer"/> 
  
  </rules>
</rules>